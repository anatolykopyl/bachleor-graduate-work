\section{РАЗРАБОТКА ПРОГРАММНОГО ОБЕСПЕЧЕНИЯ}
\subsection{Требования к разрабатываемому программному обеспечению}

Приложение имеет возможность открывать файлы результатов измерений \acrshort{ор}.
При открытии приложения пользователю доступна кнопка <<Открыть файл>>, по нажатию которой открывается файловый менеджер, в котором можно выбрать файл для открытия.
После открытия файла открывается главный \gls{вид} приложения, на нем отображаются следующие элементы управления:
\begin{itemize}
  \item график рефлектограммы;
  \item кнопка <<Библиотека файлов>>;
  \item кнопка <<Открыть файл>>;
  \item кнопка <<Сгенерировать рефлектограмму>>;
  \item кнопка <<Сохранить в библиотеку>>;
  \item поле ввода <<Лимит отражения>>;
  \item поле ввода <<Лимит поглощения>>;
  \item поле ввода <<Лимит Тигера>>;
  \item переключение отображения встроенных событий;
  \item переключение отображения найденных событий методом 1;
  \item переключение отображения найденных событий методом \acrshort{teo};
  \item переключение отображения графика результата преобразования \acrshort{teo}.
\end{itemize}

Назначение перечисленных элементов:

\subsubsection{График рефлектограммы}

Отображает рефлектограмму из открытого файла. Нажатие на рефлектограмму открывает \gls{модальное окно} содержащее следующие компоненты:

\begin{itemize}
  \item селектор <<Отражающее / неотражающее событие>>;
  \item поле ввода <<Потери>>;
  \item поле ввода <<Отражение>>;
  \item кнопка <<Закрыть>>;
  \item кнопка <<Обрезать рефлектограмму>>;
  \item кнопка <<Добавить событие>>.
\end{itemize}

Назначение перечисленных элементов (до пункта \ref{добавить_событие}):

\subsubsection{Селектор  <<Отражающее / неотражающее событие>>}

Переключение выбирает то, какое событие будет добавлено на рефлектограммму при нажатии на кнопку <<Добавить событие>>.

\subsubsection{Поле ввода <<Потери>>}

Задает количество дБ, на которое уменьшится мощность сигнала после события.

\subsubsection{Поле ввода <<Отражение>>}

Задает количество дБ, которому будет соответствовать величина обратных отражений, если будет добавлено отражающее событие.

\subsubsection{Кнопка <<Закрыть>>}

Закрывает \gls{модальное окно}.

\subsubsection{Кнопка <<Обрезать рефлектограмму>>}
\label{обрезать_рефлектограмму}

Закрывает \gls{модальное окно} и обрезает рефлектограмму в выбранном пользователем месте.

\subsubsection{Кнопка <<Добавить событие>>}
\label{добавить_событие}

Закрывает \gls{модальное окно} и добавляет пользовательское событие в выбранном месте, с параметрами соответствующим селектору <<Отражающее / неотражающее событие>> и полям <<Потери>> и <<Отражение>>.

\subsubsection{Кнопка <<Библиотека файлов>>}

Открывает \gls{вид} <<Библиотека файлов>>. На экране располагается список сохраненных ранее файлов. У каждого файла указаны его название, дата снятия измерений, id кабеля, id волокна, длина волны, коментарии к файлу.

Клик по элементу списка открывает главный \gls{вид} с соотретствующей рефлектограммой.

\subsubsection{Кнопка <<Открыть файл>>}

Дублирует функционал кнопки доступной при первоначальном запуске приложения.

\subsubsection{Кнопка <<Сохранить в библиотеку>>}

Имеет 2 состояния:
\begin{itemize}
  \item Если файл не сохранен в библиотеке приложения, то:
  
  отображается текст <<Сохранить в библиотеку>>. По нажатию открытый в данный момент файл сохраняется в библиотеку приложения и становится доступным на \glslink{вид}{виде} <<Библиотека файлов>>;
  \item если файл уже сохранен в библиотеке приложения, то:
  
  отображается текст <<Файл в библиотеке>>.
\end{itemize}

\subsubsection{Кнопка <<Сгенерировать рефлектограмму>>}

Открывает \gls{модальное окно}, в котором содержатся следующие компоненты:

\begin{itemize}
  \item поле ввода <<Затухание>>;
  \item поле ввода <<Масштаб шума>>;
  \item кнопка <<Закрыть>>;
  \item кнопка <<Сгенерировать>>.
\end{itemize}

Назначение перечисленных элементов (до пункта \ref{сгенерировать}):

\subsubsection{Поле ввода <<Затухание>>}

Задает километрическое затухание, которое будет использовано для генерации рефлектограммы.

\subsubsection{Поле ввода <<Масштаб шума>>}

Задает степень зашумленности создаваемого сигнала.

\subsubsection{Кнопка <<Закрыть>>}

Закрывает \gls{модальное окно}.

\subsubsection{Кнопка <<Сгенерировать>>}
\label{сгенерировать}

Закрывает \gls{модальное окно} и продолжает рефлектограмму с места, где она была обрезана инструментом <<Обрезать рефлектограмму>> (пункт \ref{обрезать_рефлектограмму})

\subsubsection{Поле ввода <<Лимит отражения>>}

Задает количество дБ, на которое измерение должно отличаться от предыдущего, чтобы классифицироваться как отражающее событие.

\subsubsection{Поле ввода <<Лимит поглощения>>}

Задает количество дБ, на которое измерение должно отличаться от предыдущего, чтобы классифицироваться как неотражающее событие.

\subsubsection{Поле ввода <<Лимит Тигера>>}

Задает количество дБ, которое должно превысить преобразованное оператором Тигера измерение, чтобы классифицироваться как событие.

\subsubsection{Переключатели отображения событий}

Представлены три пункта соответствующие доступным к отображению видам событий:
\begin{itemize}
  \item встроенные события~--- события которые были обнаружены и записаны в файл встроенным в \acrshort{ор} компьютером;
  \item простые события~--- события найденные методом описанным в главе \ref{простой_алгоритм};
  \item простые события~--- события найденные методом описанным в главе \ref{тео_алгоритм}.
\end{itemize}

\subsection{Описание необходимых библиотек и разработанных модулей}

Выбранные библиотеки для разработки приложения на стеке Electron + Vue + Typescript:

\begin{itemize}
  \item Electron версии 21.3.3~--- \gls{фреймворк} для разработки приложений с помощью web технологий;
  \item Vue версии 3.2.45~--- \gls{фреймворк} для разработки \glslink{реактивность}{реактивных} веб приложений;
  \item Typescript версии 4.9.4~--- язык программирования со строгой типизацией данных, который \glslink{транспиляция}{транспилируется} в Javascript;
  \item jsOTDR~--- библиотека для чтения содержимого файлов .sor с преобразованием в json;
  \item d3 версии 7.8.2~--- библиотека для визуализации данных.
  \item Pinia версии 2.1.3~--- библиотека для управления состоянием приложения для Vue;
  \item Vuetify версии 3.1.2~--- \gls{фреймворк} компонентов для Vue.
  \item Vite версии 4.0.4~--- инструмент сборки.
\end{itemize}

\subsection{Алгоритм поиска событий}

В программе реализовано 2 алгоритма поиска событий. Пользователю доступна возможность включить любой из них или оба, либо выключить оба.

\subsubsection{Простой алгоритм} \label{простой_алгоритм}

Алгоритм поиска событий основан на том, чтобы вычислить для каждого дискретного измерения рефлектометра соответствующее ему затухание относительно предыдущего измерения. Отражающие события можно достаточно просто определить если мощность в точке $n$ превышает мощность в точке $n-1$ на одну величину. А неотражающие события соответственно можно определить как падение мощности, превышающее другую величину (\ref{eqn:naive}). В большинстве рефлектометров встроенный компьютер использует в качестве этого значения $0,01 \text{ дБ}$.

\begin{equation}
  \label{eqn:naive}
  \left\{
    \begin{array}{ll}
      S_n - S_{n+1} > k_1 & \text{при } S_{n+1} \leqslant S_n \\
      S_n - S_{n+1} > k_2 & \text{при } S_{n+1} > S_n
    \end{array}
  \right.
\end{equation}

\subsubsection{Aлгоритм на основе энергетического оператора Тигера} \label{тео_алгоритм}

Альтернативным подходом к поиску событий может служить использование энергетического оператора Тигера (\acrshort{teo})~\cite{lima:teo}. Его значение для дискретного сигнала равно разнице квадрата значения в точке $n$ и произведения значений в точках $n-1$ и $n+1$ (\ref{eqn:teo}). Такой оператор очень чувствителен к изменениям и с правильно выставленным пороговым значением позволяет находить события с высокой точностью.

\begin{equation}
  \label{eqn:teo}
  \Psi[S_n] = S_n^2-S_{n-1}\cdot S_{n+1}
\end{equation}

\subsection{Реализация редактирования рефлектограммы}

\subsubsection{Обрезка рефлектограммы}

При клике на рефлектограмму вычисляется величина обратная масштабу отображения рефлектограммы и используется для того, чтобы найти элемент в массиве измеренных величин, который был кликнут. Все значения после него удаляются.

\subsubsection{Генерация рефлектограммы}

В формате SOR предусмотрено поле \mintinline{js}|info.DataPts["num data points"]|, которое содержит количество измерений сделанных \acrshort{ор}.
Программа последовательно добавляет к существующей рефлектограмме значения с соответствующими параметрами $x$ и $y$, до тех пор, пока количество значений не достигнет изначальной величины \mintinline{js}|info.DataPts["num data points"]|:

\begin{equation}
  \label{eqn:generate_x}
  x_n = x_{n-1} + r
\end{equation}

\begin{equation}
  \label{eqn:generate_y}
  y_n = y_{n-1} + \alpha \cdot r + t
\end{equation}

\noindent где \\
$\alpha$~--- километрическое затухание (дБ/км) \\
$r$~--- разшешение рефлектометра \\
$t$~--- шум

\subsubsection{Добавление событий}

Программа уменьшает мощность всех измерений следующих после события на заданную пользователем величину. 
Если добавляется отражающее событие, то в точке события мощность нескольких измерений увеличивается на заданную величину.

\subsection{Хранение рефлектограмм}

Приложение позволяет сохранять во встроенной библиотеке открытые файлы рефлектограмм. Все данные рефлектограммы представлены в приложении как объект формата JSON. JSON~--- текстовый формат обмена данными, основанный на JavaScript~\cite{web:json}. В этом же формате рефлектограммы сохраняются на диске~(листниг \ref{lst:data_format}). 
\\
\begin{lstlisting}[
  caption=Пример хранимых данных, 
  label={lst:data_format}
]
  {
    "status": "ok",
    "info": {
      "filename": "demo_ab.sor",
      "Cksum": {
        "checksum": 38827,
        "checksum_ours": 38827,
        "match": true
      },
      "KeyEvents": [
        {
          "type": "1F9999LS {auto} reflection",
          "distance": 0,
          "slope": "0.000",
          "splice loss": "0.000",
          "refl loss": "-50.000",
          "comments": " "
        },
        {
          "type": "0F9999LS {auto} loss/drop/gain",
          "distance": 12.711,
          "slope": "0.344",
          "splice loss": "0.209",
          "refl loss": "0.000",
          "comments": " "
        },
        {
          "type": "1F9999LS {auto} reflection",
          "distance": 25.351,
          "slope": "0.342",
          "splice loss": "0.087",
          "refl loss": "-51.514",
          "comments": " "
        },
        {
          "type": "0F9999LS {auto} loss/drop/gain",
          "distance": 38.047,
          "slope": "0.344",
          "splice loss": "0.149",
          "refl loss": "0.000",
          "comments": " "
        },
        {
          "type": "1E9999LS {auto} reflection",
          "distance": 50.728,
          "slope": "0.344",
          "splice loss": "13.232",
          "refl loss": "-16.726",
          "comments": " "
        }
      ],
      "FxdParams": {
        "BC": -81.5,
        "EOTThr": 5,
        "date": "1998-02-05T08:46:14.000Z",
        "lossThr": 0,
        "reflThr": 0,
        "pulseWidth": 1000,
        "wavelength": "1310.0 nm",
        "resolution": 5.094696792927346
      },
      "GenParams": {
        "cableId": "K1 AB",
        "fiberId": " "
      },
      "Summary": {
        "total loss": 0,
        "ORL": 0,
        "loss start": 0,
        "loss end": 50.727876,
        "ORL start": 0,
        "ORL finish": 50.727876
      },
      "DataPts": {
        "num data points": 11776,
        "num traces": 1,
        "num data points 2": 11776,
        "scaling factor": 1,
        "max before offset": 65.535,
        "min before offset": 15.829
      }
    },
    "infoRaw": {
      ...
    },
    "trace": [
      {
        "x": 0,
        "y": 38.48
      },
      ...
    ]
  }
\end{lstlisting}

Использование JSON обеспечивает высокую степень портативности реализации встроенной библиотеки, поскольку помимо реализованного метода хранения данных на диске, как файлов с расширением .json, можно реализовать встроенную библиотеку с функцией облачного хранилища, на основе базы данных MongoDB, которая тоже использует формат подобный JSON~\cite{web:bson}.

\subsection{Результат разработки}

В результате разработки в соответствии с требованиями было разработано приложение со следующими характеристиками:

\begin{itemize}
  \item приложение открывает файлы .sor;
  \item приложение отображает рефлектограммы открытых файлов;
  \item на рефлектограммах отображаются события:
  \begin{itemize}
    \item встроенные;
    \item найденные простым подходом;
    \item найденные с помощью \acrshort{teo}.
  \end{itemize}
  \item рефлектограмму можно обрезать в выбранном пользователем месте;
  \item на рефлектограмму можно добавить отражающее или неотражающее событие с заданными параметрами;
  \item в приложение встроена система организации результатов измерения \acrshort{ор};
  \item сохраненные результаты измерений можно просматривать и открывать из встроенной в программу библиотеки;
  \item приложение работает на операционных системах Windows, Mac OS и Linux.
\end{itemize}

\subsection{Выводы по разделу}

В разделе приведено описание необходимых библиотек и разработанных модулей, кратко представлены результаты разработки.
